<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>è›‡åƒæœˆé¥¼çš„æ•…äº‹</title>
		<style type="text/css">
			*{
				padding: 0;
				margin: 0;
			}
			html,body{
				width: 100%;
			}
			canvas{
				background: #ccc;
				margin: 10px auto;
			}
			#begin{
				width: 200px;
				height: 50px;
				background-color: orange;
				border-radius: 15px;
				margin: 20px auto;
				display: block;
				outline: none;
			}
		</style>
	</head>
	<body>
		<canvas id="canvaId" width="1400" height="600"></canvas><br />
		<button id="begin">å¼€å§‹æ¸¸æˆ</button>
	</body>
	<!-- æ˜¾ç¤ºåˆ†æ•° -->
	<!-- å¹¿å‘Š -->
	<!-- å¼¹çª— -->
	<script type="text/javascript">
		var canvas = document.getElementById("canvaId");
		var begin = document.getElementById("begin")
		// å…¨å±€å˜é‡ctx
		var ctx = canvas.getContext("2d");
		// ã€åŸå‹å¯¹è±¡ã€‘
		// ä¼ å…¥çš„å‚æ•°optionsæ˜¯ä¸ªå¯¹è±¡
		function Snake(options){
			this.width = options.width;
			this.height = options.height;
			//æ¯ä¸€æ ¼å­çš„å®½é«˜ 20px
			this.space = options.space;
			// æ¸¸æˆåˆ—æ•° 30åˆ—
			this.colCount = this.width / this.space;
			// æ¸¸æˆè¡Œæ•°  30è¡Œ
			this.rowCount = this.height / this.space;
			// é»˜è®¤æ¸¸æˆæ–¹å‘(å‘å³)
			this.direction = "right";
			// å®šæ—¶å™¨
			this.timer = null;
			// ç”»ç¬”
			this.ctx = options.ctx;
		}
		//prototype (å¾ˆé‡è¦) ä½¿å¾—ä¸€äº›å±æ€§å¯ä»¥è¢«ç»§æ‰¿ï¼ˆå…±äº«ï¼‰
		//1ã€åˆå§‹åŒ–æ–¹æ³•
		Snake.prototype.init = function(){
			// ç»˜åˆ¶åœ°å›¾
			this.drawMap();
			// ç»˜åˆ¶åˆå§‹è›‡
			this.drawInitSnake();
			// ç»˜åˆ¶åˆå§‹é£Ÿç‰©
			this.drawInitFood();
		}
		// 2ã€å¼€å§‹æ–¹æ³•
		Snake.prototype.begin = function(){
			var _this = this;
			// ç›‘å¬é”®ç›˜äº‹ä»¶
			this.addEvnet();
			// å®šæ—¶å™¨
			this.timer = setInterval(function(){	
				// æ¯éš”150msåˆ·æ–°ç»˜åˆ¶ä¸€æ¬¡è›‡
				_this.drawSnake();
			},150)
		}
		//======== åˆå§‹åŒ–çš„è›‡çš„èº«ä½“==========
		Snake.prototype.drawInitSnake = function(){
			this.snake = [
				{x: 0, y: 20, color: "blue"},
				{x: 20, y: 20, color: "green"},
				{x: 40, y: 20, color: "red"}
			]
			//ç»˜åˆ¶è›‡èº«ä½“
			for(var j = 0 ; j < this.snake.length; j++){
				this.ctx.beginPath();
				this.ctx.rect(this.snake[j].x, this.snake[j].y,
					this.space, this.space);
				this.ctx.fillStyle = this.snake[j].color;
				this.ctx.fill();
			}
		}
		//========åˆå§‹åŒ–çš„é£Ÿç‰©çš„åæ ‡=========
		Snake.prototype.drawInitFood = function(){
			this.food = {
				x: 80,
				y: 40,
				color: "orange"
			}
			//ç»˜åˆ¶é£Ÿç‰©
			this.ctx.beginPath();
			this.ctx.rect(this.food.x, this.food.y,
				this.space, this.space);
			this.ctx.fillStyle = this.food.color;
			this.ctx.fill();
		}
		//2ã€ç»˜åˆ¶åœ°å›¾
		Snake.prototype.drawMap = function(){
			// è®¾ç½®ç”»ç¬”é¢œè‰²
			this.ctx.strokeStyle = "#333";
			// å¾ªç¯ç»˜åˆ¶
			for(var i = 0 ; i <= this.colCount; i++){
				this.ctx.moveTo(0, i * this.space);
				this.ctx.lineTo(this.width, i * this.space);
				this.ctx.moveTo(i * this.space, 0);
				this.ctx.lineTo(i * this.space, this.height);
				this.ctx.stroke();
			}
		}
		//3ã€ç›‘å¬é”®ç›˜äº‹ä»¶
		Snake.prototype.addEvnet = function(){
			var _this = this;
			document.addEventListener('keydown',function(){
				console.log(123)
			})
			document.addEventListener('keydown',function(evt){
				console.log("ğŸğŸ")
				var event = evt || window.event;
				var keyCode = event.keyCode;
				// this è°è°ƒç”¨å‡½æ•°ï¼ˆäº‹ä»¶ï¼‰ this æŒ‡å‘è° document
				if(keyCode == 38 && _this.direction != 'down'){
					_this.direction = 'up'
				}
				if(keyCode == 40 && _this.direction != 'up'){
					_this.direction = 'down'
				}
				if(keyCode == 37 && _this.direction != 'right'){
					_this.direction = 'left'
				}
				if(keyCode == 39 && _this.direction != 'left'){
					_this.direction = 'right'
				}
				//console.log(_this.direction)
			})
		}
		//4ã€åˆ¤æ–­è›‡åƒåˆ°é£Ÿç‰©
		Snake.prototype.eatFood = function(){
			//æ£€æµ‹è›‡å¤´å’Œé£Ÿç‰©çš„ç¢°æ’
			if(this.snake[this.snake.length - 1].x == this.food.x &&
				this.snake[this.snake.length - 1].y == this.food.y){
				// è›‡åƒåˆ°é£Ÿç‰©éœ€è¦å¾€è›‡çš„å°¾éƒ¨æ·»åŠ ä¸€ä¸ªæ ¼å­
				this.addSnake();
				// è›‡åƒåˆ°é£Ÿç‰©çš„æ—¶å€™ å†æ¬¡åˆ›å»ºæ–°çš„é£Ÿç‰©
				this.createFood();
			}
		}
		//5ã€åˆ›å»ºé£Ÿç‰©
		Snake.prototype.createFood = function(){
			this.food = {
				x: Math.floor(Math.random() * this.colCount) * this.space,
				y: Math.floor(Math.random() * this.rowCount) * this.space,
				color: "orange"
			}
			this.ctx.beginPath();
			this.ctx.rect(this.food.x, this.food.y, this.space, this.space);
			this.ctx.fillStyle = this.food.color;
			this.ctx.fill();
		}
		//6ã€ è®¾ç½®è›‡ç§»åŠ¨çš„å‡½æ•°
		Snake.prototype.snakeMove = function(){
			this.x = 0;// æ°´å¹³æ–¹å‘ç§»åŠ¨
			this.y = 0; //å‚ç›´æ–¹å‘ç§»åŠ¨
			// console.log(this.direction)
			if(this.direction == 'right'){
				this.x = this.space;
			}
			if(this.direction == 'left'){
				this.x = -this.space;
			}
			if(this.direction == 'down'){
				this.y = this.space
			}
			if(this.direction == 'up'){
				this.y = -this.space;
			}
	 		// æ¯æ¬¡æ‰§è¡Œæ‰§è¡Œ æ¸…é™¤ç”»å¸ƒäº†ä¹‹åï¼Œè›‡çš„åæ ‡éœ€è¦æ›´æ–°
		 	for(var i = 0 ; i < this.snake.length - 1; i++){
		 		this.snake[i].x = this.snake[i + 1].x;
		 		this.snake[i].y = this.snake[i + 1].y;
		 	}
		 	// è®¾ç½®è›‡å¤´çš„ä¸‹ä¸€ä¸ªåŠ¨ä½œåæ ‡
		 	this.snake[this.snake.length-1].x += this.x;
		 	this.snake[this.snake.length-1].y += this.y;
		}
		//7ã€ç»˜åˆ¶è›‡
		Snake.prototype.drawSnake = function(){
			// æ¸…é™¤æŒ‡å®šçš„åŒºåŸŸ
			this.ctx.clearRect(this.snake[0].x, this.snake[0].y,
				this.space,this.space);
			this.drawMap();
			this.snakeMove();
			//ç»˜åˆ¶æ›´æ–°è›‡çš„ä½ç½® å†æ¬¡éå†è›‡çš„æ•°ç»„ï¼ˆä¸‹ä¸€ä¸ªåŠ¨ä½œï¼‰
			for(var j = 0 ; j < this.snake.length; j++){
				this.ctx.beginPath();
				this.ctx.rect(this.snake[j].x, this.snake[j].y,
					this.space, this.space);
				this.ctx.fillStyle = this.snake[j].color;
				this.ctx.fill();
			}
			//åˆ›å»ºè›‡èº«ä½“
			this.eatFood();
			//è®°å½•è›‡çš„èº«ä½“çš„åæ ‡
			this.copySnake();
		}
		//8ã€å¾€è›‡æ•°ç»„æ·»åŠ ä¸€ä¸ªæ ¼å­
		Snake.prototype.addSnake = function(){
			var new_snake_body = {
				x: this.snake[0].x - this.space,
				x: this.snake[0].y - this.space,
				color: "blue"
			}
			//è›‡åƒåˆ°é£Ÿç‰©éœ€è¦å¾€å°¾å·´æ·»åŠ ä¸€ä¸ªï¼ˆæ ¼å­ï¼‰åæ ‡
			this.snake.unshift(new_snake_body);
		}
		//9ã€åˆ¤æ–­è›‡æ˜¯å¦æ’å¢™/è›‡å¤´ç¢°åˆ°è›‡èº« (æ£€æµ‹ç¢°æ’)
		Snake.prototype.toCheck = function(){
			//è®°å½•è›‡å¤´
			var snakeHead = this.snake[this.snake.length - 1];
			if(snakeHead.x  < 0 || snakeHead.x > this.width ||
				snakeHead.y < 0 || snakeHead.y > this.height){
				alert("é£å‡ºåœ°çƒğŸŒäº†")
				clearInterval(this.timer)
			}
			//åŒå±‚å¾ªç¯
			for(var i = 0; i < this.newSnake.length; i++){
					for(var j = i + 1; j<this.newSnake.length; j++){
						// æ›´æ–°è¿‡åçš„è›‡å¤´åæ ‡å’Œè›‡èº«ä½“åæ ‡æ¯”è¾ƒ å¦‚æœå­˜åœ¨ç›¸ç­‰
						// è¯´æ˜è›‡å¤´ç¢°åˆ°è›‡èº«ä½“äº†
						if(this.newSnake[j].x == this.newSnake[i].x &&
							this.newSnake[j].y == this.newSnake[i].y){
							clearInterval(this.timer);
							alert("å°¼ç›å’¬åˆ°è‡ªå·±çš„å±è‚¡äº†!")
							return; // ç»ˆæ­¢ä»£ç 
						}
					}
			}
		}
		//10ã€ç”Ÿæˆæ–°çš„è›‡ğŸ
		Snake.prototype.copySnake = function(){
			// åˆ›å»ºæ–°è›‡æ•°ç»„
			this.newSnake = [];
			for(var i = 0 ; i < this.snake.length; i++){
				this.newSnake.push({
					x: this.snake[i].x,
					y: this.snake[i].y
				})
			}
			// è°ƒç”¨æ£€æµ‹è›‡æ´»åŠ¨æ˜¯å¦è¶…å‡ºèŒƒå›´å’Œåƒåˆ°é£Ÿç‰©çš„å‡½æ•°
			this.toCheck(this.newSnake);
		}
		//å®ä¾‹åŒ–ä¸€ä¸ªã€Snakeæ¸¸æˆå¯¹è±¡ã€‘
		var snakeGame = new Snake({
			width: canvas.width,
			height: canvas.height,
			space: 20,
			ctx: ctx
		})
		// åˆå§‹åŒ–æ¸¸æˆ
		snakeGame.init();
		// ç‚¹å‡»å¼€å§‹æŒ‰é’®ï¼Œå¼€å§‹æ¸¸æˆ
		begin.onclick = function () {
			// å¼€å§‹æ¸¸æˆ
			snakeGame.begin()
		}
	</script>
</html>
